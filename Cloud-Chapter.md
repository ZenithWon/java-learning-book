## 微服务篇

#### 微服务组件

**Spring Cloud**

注册中心（Eureka）、负载均衡（Ribbon）、远程调用（Feign）、熔断降级（Hystrix）、网关（Gateway）

**Spring Cloud Alibaba**

注册中心（Nacos）、负载均衡（Ribbon）、远程调用（Feign）、熔断降级（Sentinel）、网关（Gateway）



#### 注册中心

* 服务注册：服务提供者需要把自己的信息注册到注册中心，由注册中心保存这些信息，比如服务名称、IP、端口等
* 服务发现：当消费者需要远程调用的时候，会请求注册中心获取服务的信息，如果是一个服务集群，那么会通过Ribbon负载均衡算法，选择其中一个实例调用
* 服务监控：注册中心会实时监控服务的健康状态，一旦发现某个实例下线，就会从自己的服务列表中剔除掉，比如通过心跳的机制监控

常用的注册中心有两个，分别是Nacos和Eureka，二者区别在于：

* Nacos的非临时实例，不是由实例自己向nacos发送心跳，而是由nacos会主动向实例发送心跳，但是Eureka没有临时实例这种概念

* 当有服务实例的信息发送变更，nacos会主动向其他服务推送变更信息，但是eureka没有推送的操作



#### 负载均衡

**Ribbon流程**

当消费者需要远程调用的时候，会请求注册中心获取服务的信息，如果是一个服务集群，那么会通过Ribbon负载均衡算法，选择其中一个实例调用

**负载均衡算法**

* RoundRobinRule：简单轮询算法
* WeightResponseTimeRule：按照权重来选择服务器，响应时间越长权重越小
* RandomRule：随机选
* ZoneAvoidanceRule：使用Zone对服务器分类，优先对同一区域的服务器轮询，都没有才会去其他Zone轮询
* BestAvailableRule：忽略短路的服务器，并选择并发数少的服务器
* RetryRule：先通过轮询访问，如果服务器失效会一直重试
* AvailableFilteringRule：先过滤非健康的，然后再去选择连接数小的服务器

> 前四个比较重要

**自定义负载均衡策略**

实现IRule接口，并交给容器管理

或者在配置文件中给每个单独的服务自定义负载均衡策略



#### 服务雪崩

在服务的远程调用中，一旦一个服务不可用，会导致整个调用链都不可用

<img src="http://s5cc1wj96.hd-bkt.clouddn.com/image-20231208165935723.png" alt="image-20231208165935723" style="zoom: 50%;" />

解决方案：使用熔断降级解决，同时使用限流预防

**熔断降级**

服务降级是一种服务的自我保护方式，确保在服务不可用的时候服务不会崩溃。其实就是服务在不可用的时候，回复一个default response

服务熔断，用于检测服务调用的情况，如果服务降级过于频繁，那么会直接禁止请求该服务直接降级，之后每隔一段时间都会请求一次服务，如果成功就会恢复正常。

> 注意：服务熔断会直接停止访问该服务，其实其他的接口是好的也无法访问，而服务降级仅仅针对于不可用的接口

<img src="http://s5cc1wj96.hd-bkt.clouddn.com/image-20231208172908845.png" alt="image-20231208172908845" style="zoom:50%;" />